#!/usr/bin/env python
import sys
sys.path.append('..')
from os.path import join, exists
from itertools import product
from textwrap import dedent
from src.core import W80ROOT

if __name__ == '__main__':

    template = """
    #!/bin/bash
    #############################
    #SBATCH -J {rname}
    #SBATCH -p express
    #SBATCH -N {nnodes}
    #SBATCH --tasks-per-node=16
    #SBATCH -t {whours:02d}:{wmins:02d}:00
    #SBATCH -o {rname}-%j.out
    #SBATCH -e {rname}-%j.err
    #SBATCH -D .
    #############################

    echo "#0 LOADING MODULES"
    source /etc/profile.d/profile.modules.sh
    module load openmpi/1.10.3/gcc

    echo "#1 EXECUTING"
    for i in {{1..5}}; do mpirun ../bin/fit --pipeline {pipeline} --passband {passband} --nights {nights} --approach {approach} --lc-type {lctype} --noise {noise} --n-walkers 600 --de-n-iterations 5000 --de-update-interval 100 --de-save-interval 500 --do-mc --mc-n-iterations 10000 --mc-update-interval 200 --mc-save-interval 1000 --mc-thin 200 --mc-n-runs 1 {ldtk}; done
    """

    passbands = 'w', 'nb', 'K', 'Na', 'pr'
    approaches = 'abs', 'dw'
    noises = 'white', 'red'

    for approach in ['abs','absc','abss','dw']:
        whours, wmins = 2, 0
        for pb,noise,night in product(passbands, noises, [1,2,12]):
            bname = '{}_{}_{}_{}'.format(pb,approach,noise,night)
            with open(join(W80ROOT, 'runs', bname), 'w') as f:
                f.write(dedent(template.format(rname=bname, nnodes=4, pipeline='gc', passband=pb, nights=night, approach=approach, 
                                               lctype='relative', noise=noise, ldtk='', whours=whours, wmins=wmins)).strip())

        for pb,noise,night in product(passbands, noises, [1,2,12]):
            bname = '{}_{}_{}_{}_ldtk'.format(pb,approach,noise,night)
            with open(join(W80ROOT, 'runs', bname), 'w') as f:
                f.write(dedent(template.format(rname=bname, nnodes=4, pipeline='gc', passband=pb, nights=night, approach=approach, 
                                        lctype='relative', noise=noise, ldtk='--use-ldtk', whours=whours, wmins=wmins)).strip())
